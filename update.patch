---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# update
# https://cloud.redhat.com/insights/remediations/35623d42-1ab9-4b46-a592-8a0e07904dd4
# Generated by Red Hat Insights on Tue, 30 Jun 2020 11:58:48 GMT
# Created by mdassen@imamu.edu.sa

# Upgrade packages affected by CVE-2020-0543
# Identifier: (vulnerabilities:CVE-2020-0543,fix)
# Version: 552ffa63dc334ccf3400dda2a8d7d267d8528ef9
- name: update vulnerable packages
  hosts: "x55c1bb02ab.imam.com,x55c1bb03ab.imam.com,x55c1bb0bab.imam.com,x55c1bb0cab.imam.com,x55c1bb0dab.imam.com,x55c1bb0eab.imam.com,x55c1bb0fab.imam.com,x55c1bb0gab.imam.com,x55c1bb0hab.imam.com,x55c1bb0iab.imam.com,x55c1bb0jab.imam.com,x55c1bb0lab.imam.com,x55c1bb0mab.imam.com"
  become: true
  tasks:
    - name: check for update
      shell: "{{ ansible_facts['pkg_mgr'] }} check-update -q --cve CVE-2020-0543"
      check_mode: no
      register: check_out
      failed_when: check_out.rc != 0 and check_out.rc != 100
      args:
        warn: false

    - when: check_out.rc == 100
      name: upgrade package
      shell: "{{ ansible_facts['pkg_mgr'] }} upgrade -v -y --cve CVE-2020-0543"
      args:
        warn: false

    - when: check_out.rc == 100
      name: set reboot fact
      set_fact:
        insights_needs_reboot: True

# Automatic system reboot was suppressed for this playbook.
# This play lists the systems that need to be rebooted manually for the changes to take effect.
- name: Reboot reminder
  hosts: "x55c1bb02ab.imam.com,x55c1bb03ab.imam.com,x55c1bb0bab.imam.com,x55c1bb0cab.imam.com,x55c1bb0dab.imam.com,x55c1bb0eab.imam.com,x55c1bb0fab.imam.com,x55c1bb0gab.imam.com,x55c1bb0hab.imam.com,x55c1bb0iab.imam.com,x55c1bb0jab.imam.com,x55c1bb0lab.imam.com,x55c1bb0mab.imam.com"
  gather_facts: False
  tasks:
    - debug:
        msg: "Automatic system reboot was suppressed for this playbook. Reboot {{inventory_hostname}} manually for the changes to take effect."
      when:
        - insights_needs_reboot is defined
        - insights_needs_reboot

- name: run insights
  hosts: "x55c1bb02ab.imam.com,x55c1bb03ab.imam.com,x55c1bb0bab.imam.com,x55c1bb0cab.imam.com,x55c1bb0dab.imam.com,x55c1bb0eab.imam.com,x55c1bb0fab.imam.com,x55c1bb0gab.imam.com,x55c1bb0hab.imam.com,x55c1bb0iab.imam.com,x55c1bb0jab.imam.com,x55c1bb0lab.imam.com,x55c1bb0mab.imam.com"
  become: True
  gather_facts: False
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false
