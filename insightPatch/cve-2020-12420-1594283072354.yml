---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# CVE-2020-12420
# https://cloud.redhat.com/insights/remediations/04abff41-d91f-4422-9639-0381e64a2ecd
# Generated by Red Hat Insights on Thu, 09 Jul 2020 08:24:32 GMT
# Created by mdassen@imamu.edu.sa

# Upgrade packages affected by CVE-2020-12420
# Identifier: (vulnerabilities:CVE-2020-12420,fix)
# Version: 552ffa63dc334ccf3400dda2a8d7d267d8528ef9
- name: update vulnerable packages
  hosts: bb-app-prd
  become: true
  become_user: root
  tasks:
    - name: check for update
      shell: "{{ ansible_facts['pkg_mgr'] }} check-update -q --cve CVE-2020-12419 --cve CVE-2020-12421 --cve CVE-2020-12418 --cve CVE-2020-0543 --cve CVE-2020-12405 --cve CVE-2020-12410  --cve CVE-2020-12406 --cve CVE-2020-9484 --cve CVE-2020-8616 --cve CVE-2020-8617 --cve CVE-2020-13112 --cve CVE-2020-10711 --cve CVE-2020-12387 --cve CVE-2020-12392 --cve CVE-2020-12395 --cve CVE-2020-6831 --cve CVE-2020-2756 --cve CVE-2020-2757 CVE-2020-2773"
      check_mode: no
      register: check_out
      failed_when: check_out.rc != 0 and check_out.rc != 100
      args:
        warn: false

    - when: check_out.rc == 100
      name: upgrade package
      shell: "{{ ansible_facts['pkg_mgr'] }} upgrade -v -y --cve CVE-2020-12419 --cve CVE-2020-12421 --cve CVE-2020-12418 --cve CVE-2020-0543 --cve CVE-2020-12405 --cve CVE-2020-12410  --cve CVE-2020-12406 --cve CVE-2020-9484 --cve CVE-2020-8616 --cve CVE-2020-8617 --cve CVE-2020-13112 --cve CVE-2020-10711 --cve CVE-2020-12387 --cve CVE-2020-12392 --cve CVE-2020-12395 --cve CVE-2020-6831 --cve CVE-2020-2756 --cve CVE-2020-2757 CVE-2020-2773"
      args:
        warn: false

    - when: check_out.rc == 100
      name: set reboot fact
      set_fact:
        insights_needs_reboot: True

# Automatic system reboot was suppressed for this playbook.
# This play lists the systems that need to be rebooted manually for the changes to take effect.
- name: Reboot reminder
  hosts: bb-app-prd
  gather_facts: False
  tasks:
    - debug:
        msg: "Automatic system reboot was suppressed for this playbook. Reboot {{inventory_hostname}} manually for the changes to take effect."
      when:
        - insights_needs_reboot is defined
        - insights_needs_reboot

- name: run insights
  hosts: bb-app-prd
  become: True
  gather_facts: False
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false